<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meeve ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Antique&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Special+Elite&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Rajdhani:wght@400;700&family=Orbitron:wght@400;700&family=Share+Tech+Mono&family=VT323&family=Exo+2:wght@400;700&family=Russo+One&family=Michroma&family=Nova+Square&display=swap" rel="stylesheet">
  <style>
    /*
      PALETA EXTRA√çDA DEL AVATAR:
      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      TRAJE (negro profundo)  ‚Üí base oscura de la UI
      CAMISA (blanco-crema)   ‚Üí texto claro, elementos sobre oscuro
      CORBATA (rojo intenso)  ‚Üí acento, alertas, destacados
      GUANTES (gris oscuro)   ‚Üí bordes, separadores
      FONDO CHECKER AVATAR    ‚Üí fondos de panel (grises medios)

      ESTRUCTURA:
      ‚Ä¢ Header / Sidebar / Input bar ‚Üí negro del traje (#1e1c1a)
      ‚Ä¢ √Årea de chat               ‚Üí gris medio del fondo checker (#6a6866)
      ‚Ä¢ Cards en sidebar           ‚Üí gris guantes (#2e2c2a)
      ‚Ä¢ Texto sobre oscuro         ‚Üí crema camisa (#dedad4)
      ‚Ä¢ Texto sobre gris medio     ‚Üí negro suave (#1e1c1a)
      ‚Ä¢ Acento √∫nico               ‚Üí rojo corbata (#c8251c)
    */
    :root {
      /* Negros del traje */
      --traje:        #1e1c1a;
      --traje-light:  #2a2826;
      --guante:       #363432;

      /* Blancos/crema de la camisa */
      --camisa:       #dedad4;
      --camisa-dim:   rgba(222,218,212,0.55);
      --camisa-muted: rgba(222,218,212,0.35);

      /* Rojo de la corbata */
      --corbata:      #c8251c;
      --corbata-soft: rgba(200,37,28,0.15);
      --corbata-dim:  rgba(200,37,28,0.08);

      /* Grises del fondo checker del avatar */
      --checker-dark:  #5a5856;   /* sidebar */
      --checker-mid:   #686664;   /* fondo chat */
      --checker-light: #747270;   /* cards/mensajes */
      --checker-pale:  #807e7c;   /* hover */

      /* Bordes */
      --stroke-dark:  rgba(10,8,6,0.5);
      --stroke-mid:   rgba(10,8,6,0.25);
      --stroke-light: rgba(10,8,6,0.12);

      --shadow: 2px 3px 0 rgba(10,8,6,0.3);

      --font-title: 'Zen Antique', serif;
      --font-body:  'Crimson Pro', serif;
      --font-mono:  'Special Elite', monospace;
      --ov-emote-size: 24px;
    }

    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

    body {
      background: var(--checker-mid);
      color: var(--traje);
      font-family: var(--font-body);
      min-height: 100vh;
      overflow: hidden;
    }

    body.no-glow .platform-dot.ok { box-shadow:none!important; }
    body.no-glow #ws-dot.ok       { box-shadow:none!important; }
    body.no-glow .msg-item.highlighted { box-shadow:none!important; }

    /* Part√≠culas */
    .particles { position:fixed;inset:0;z-index:1;pointer-events:none;overflow:hidden; }
    .particle  { position:absolute;background:var(--traje);opacity:0;border-radius:1px;animation:floatUp linear infinite; }
    @keyframes floatUp {
      0%  {opacity:0;   transform:translateY(105vh) rotate(var(--r,10deg));}
      12% {opacity:0.04;}
      88% {opacity:0.015;}
      100%{opacity:0;   transform:translateY(-8vh) rotate(calc(var(--r)+20deg));}
    }

    /* ‚ïê‚ïê HEADER ‚Äî negro traje con l√≠nea roja corbata ‚ïê‚ïê */
    header {
      position:fixed;top:0;left:0;right:0;height:54px;
      background:var(--traje);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 20px;z-index:200;
      border-bottom:2px solid var(--corbata);
      box-shadow:0 2px 0 rgba(200,37,28,0.2), 0 6px 24px rgba(10,8,6,0.5);
    }
    .header-left{display:flex;align-items:center;gap:11px;}

    .logo-img {
      width:40px;height:40px;border-radius:50%;object-fit:cover;
      filter:grayscale(100%) contrast(1.35) brightness(0.8);
      border:1.5px solid var(--corbata);
      box-shadow:2px 2px 0 rgba(10,8,6,0.4),0 0 0 1px rgba(200,37,28,0.25);
      animation:logoWobble 6s ease-in-out infinite;flex-shrink:0;
    }
    @keyframes logoWobble {
      0%,100%{transform:rotate(-1.5deg) translateY(0);}
      35%    {transform:rotate(1.2deg)  translateY(-2px);}
      65%    {transform:rotate(-0.4deg) translateY(-1px);}
    }

    .header-text{display:flex;flex-direction:column;gap:1px;}
    .header-title   {font-family:var(--font-title);font-size:16px;letter-spacing:5px;color:var(--camisa);text-transform:uppercase;line-height:1;}
    .header-subtitle{font-family:var(--font-body);font-size:9px;font-style:italic;color:var(--camisa-dim);letter-spacing:1.5px;}

    .header-right{display:flex;align-items:center;gap:8px;}
    #ws-dot{width:7px;height:7px;border-radius:50%;background:var(--guante);border:1.5px solid var(--stroke-dark);transition:all 0.4s;flex-shrink:0;}
    #ws-dot.ok{background:var(--corbata);box-shadow:0 0 0 3px rgba(200,37,28,0.2);border-color:var(--corbata);animation:dotPulse 2.5s ease-in-out infinite;}
    @keyframes dotPulse{0%,100%{box-shadow:0 0 0 3px rgba(200,37,28,0.2);}50%{box-shadow:0 0 0 6px rgba(200,37,28,0.06);}}
    #ws-label{font-family:var(--font-mono);font-size:10px;color:var(--camisa-dim);letter-spacing:1px;text-transform:uppercase;}

    /* ‚ïê‚ïê LAYOUT ‚ïê‚ïê */
    .layout{position:fixed;top:54px;left:0;right:0;bottom:0;display:flex;z-index:10;overflow:hidden;}

    /* ‚ïê‚ïê SIDEBAR ‚Äî gris oscuro, un tono m√°s claro que el header ‚ïê‚ïê */
    .sidebar{
      width:294px;min-width:294px;
      background:var(--checker-dark);
      border-right:1px solid rgba(10,8,6,0.4);
      box-shadow:2px 0 12px rgba(10,8,6,0.3);
      overflow-y:auto;overflow-x:hidden;
      padding:11px 10px;display:flex;flex-direction:column;gap:7px;
      transition:transform 0.4s cubic-bezier(0.4,0,0.2,1),min-width 0.4s,width 0.4s,border-color 0.3s,padding 0.4s;
      flex-shrink:0;z-index:20;
    }
    .sidebar.collapsed{transform:translateX(-294px);min-width:0;width:0;border-color:transparent;padding:0;}
    .sidebar::-webkit-scrollbar{width:3px;}
    .sidebar::-webkit-scrollbar-thumb{background:rgba(10,8,6,0.3);border-radius:2px;}

    #sidebar-toggle{
      position:fixed;top:50%;left:294px;
      transform:translateY(-50%) translateX(-50%);
      width:16px;height:44px;
      background:var(--checker-dark);
      border:1px solid rgba(10,8,6,0.35);border-left:none;
      border-radius:0 5px 5px 0;cursor:pointer;z-index:300;
      display:flex;align-items:center;justify-content:center;
      transition:left 0.4s cubic-bezier(0.4,0,0.2,1),background 0.2s;
    }
    #sidebar-toggle:hover{background:var(--guante);}
    #sidebar-toggle.collapsed{left:0;border-left:1px solid rgba(10,8,6,0.35);border-right:none;border-radius:5px 0 0 5px;}
    .toggle-arrow{font-size:9px;color:var(--camisa-muted);user-select:none;transition:transform 0.4s;}
    #sidebar-toggle.collapsed .toggle-arrow{transform:rotate(180deg);}

    /* ‚ïê‚ïê CARDS ‚Äî negro guante sobre gris sidebar ‚ïê‚ïê */
    .card{
      background:var(--guante);
      border-top:   1.5px solid rgba(10,8,6,0.5);
      border-left:  1.5px solid rgba(10,8,6,0.5);
      border-right: 1px   solid rgba(10,8,6,0.2);
      border-bottom:1px   solid rgba(10,8,6,0.2);
      border-radius:2px 5px 3px 4px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      position:relative;overflow:hidden;
    }
    /* L√≠nea corbata arriba de cada card */
    .card::before{
      content:'';position:absolute;top:0;left:0;right:0;height:2px;
      background:linear-gradient(90deg,var(--corbata),rgba(200,37,28,0.2) 55%,transparent);
    }
    .card-title{
      font-family:var(--font-title);font-size:8.5px;letter-spacing:3px;
      text-transform:uppercase;color:var(--camisa-dim);margin-bottom:8px;
      display:flex;align-items:center;gap:6px;
    }
    .card-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(200,37,28,0.3),transparent);}

    /* ‚ïê‚ïê INPUTS ‚Äî fondo traje oscuro ‚ïê‚ïê */
    label{display:block;font-family:var(--font-mono);font-size:8.5px;color:var(--camisa-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px;}
    .input-row{display:flex;gap:5px;}

    input[type=text],input[type=number],select{
      background:var(--traje-light);
      border-top:  1px solid rgba(10,8,6,0.5);
      border-left: 1px solid rgba(10,8,6,0.5);
      border-right:1px solid rgba(10,8,6,0.15);
      border-bottom:1px solid rgba(10,8,6,0.15);
      border-radius:2px 4px 3px 3px;
      padding:6px 9px;color:var(--camisa);
      font-family:var(--font-body);font-size:12px;outline:none;flex:1;
      transition:border-color 0.2s,box-shadow 0.2s;
    }
    input[type=text]:focus,input[type=number]:focus,select:focus{
      border-color:var(--corbata);box-shadow:0 0 0 2px var(--corbata-dim);
    }
    input::placeholder{color:var(--camisa-muted);}
    select{
      cursor:pointer;-webkit-appearance:none;appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23dedad4'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:right 9px center;
      padding-right:26px;background-color:var(--traje-light);
    }

    /* ‚ïê‚ïê BOTONES ‚ïê‚ïê */
    .btn{
      padding:6px 13px;border-radius:2px 4px 3px 3px;border:none;
      font-family:var(--font-mono);font-size:9.5px;font-weight:700;
      cursor:pointer;transition:all 0.13s;white-space:nowrap;letter-spacing:0.7px;text-transform:uppercase;
    }
    /* Primario: corbata roja */
    .btn-primary{
      background:var(--corbata);color:var(--camisa);
      border-top: 1.5px solid rgba(200,37,28,0.9);
      border-left:1.5px solid rgba(200,37,28,0.9);
      border-right:1.5px solid rgba(200,37,28,0.4);
      border-bottom:1.5px solid rgba(200,37,28,0.4);
      box-shadow:var(--shadow);
    }
    .btn-primary:hover {background:#a01e16;transform:translate(-1px,-1px);box-shadow:3px 4px 0 rgba(10,8,6,0.3);}
    .btn-primary:active{transform:translate(1px,1px);box-shadow:none;}

    /* Secundario: guante oscuro */
    .btn-secondary{
      background:var(--traje-light);color:var(--camisa);
      border-top: 1px solid rgba(10,8,6,0.5);
      border-left:1px solid rgba(10,8,6,0.5);
      border-right:1px solid rgba(10,8,6,0.15);
      border-bottom:1px solid rgba(10,8,6,0.15);
      box-shadow:var(--shadow);
    }
    .btn-secondary:hover {background:var(--guante);border-color:rgba(10,8,6,0.7);transform:translate(-1px,-1px);box-shadow:3px 4px 0 rgba(10,8,6,0.2);}
    .btn-secondary:active{transform:translate(1px,1px);box-shadow:none;}

    .btn-full{width:100%;}
    .btn-danger{
      background:var(--corbata-dim);color:var(--corbata);
      border:1.5px solid rgba(200,37,28,0.35);box-shadow:var(--shadow);
    }
    .btn-danger:hover{background:var(--corbata-soft);border-color:var(--corbata);}
    .btn-row{display:flex;gap:5px;}

    /* ‚ïê‚ïê TOGGLES ‚ïê‚ïê */
    .toggle-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:3px 0;}
    .toggle-label{font-family:var(--font-mono);font-size:9.5px;color:var(--camisa);flex:1;}
    .toggle-switch{position:relative;width:34px;height:17px;flex-shrink:0;}
    .toggle-switch input{opacity:0;width:0;height:0;position:absolute;}
    .toggle-slider{
      position:absolute;inset:0;background:var(--traje);
      border:1px solid rgba(10,8,6,0.5);border-radius:17px;cursor:pointer;transition:all 0.22s;
    }
    .toggle-slider::before{
      content:'';position:absolute;width:11px;height:11px;
      left:2px;top:50%;transform:translateY(-50%);
      background:var(--checker-light);border-radius:50%;transition:all 0.22s;
    }
    .toggle-switch input:checked+.toggle-slider{background:var(--corbata);border-color:var(--corbata);}
    .toggle-switch input:checked+.toggle-slider::before{left:19px;background:var(--camisa);}

    /* ‚ïê‚ïê PLATFORM ROWS ‚ïê‚ïê */
    .platform-row{
      display:flex;align-items:center;gap:8px;padding:6px 9px;
      background:var(--traje-light);
      border-top:  1px solid rgba(10,8,6,0.45);
      border-left: 1px solid rgba(10,8,6,0.45);
      border-right:1px solid rgba(10,8,6,0.12);
      border-bottom:1px solid rgba(10,8,6,0.12);
      border-radius:2px 4px 3px 3px;margin-bottom:4px;
      box-shadow:1px 2px 0 rgba(10,8,6,0.15);transition:border-color 0.2s;
    }
    .platform-row:last-child{margin-bottom:0;}
    .platform-row:hover{border-color:rgba(200,37,28,0.35);}
    .platform-dot{width:6px;height:6px;border-radius:50%;background:var(--guante);flex-shrink:0;border:1px solid rgba(10,8,6,0.4);transition:all 0.3s;}
    .platform-dot.ok{background:var(--corbata);box-shadow:0 0 0 3px rgba(200,37,28,0.18);border-color:var(--corbata);}
    .platform-icon{font-size:13px;filter:grayscale(100%) contrast(0.5) brightness(1.8);}
    .platform-info{flex:1;min-width:0;}
    .platform-name{font-family:var(--font-title);font-size:11.5px;color:var(--camisa);letter-spacing:0.3px;}
    .platform-channel{font-family:var(--font-mono);font-size:8.5px;color:var(--camisa-muted);}
    .tag{display:inline-block;padding:1px 6px;border-radius:999px;font-family:var(--font-mono);font-size:7.5px;font-weight:700;letter-spacing:0.5px;}
    .tag-connector{background:rgba(222,218,212,0.08);border:1px solid rgba(222,218,212,0.18);color:var(--camisa-dim);}
    .tag-puppeteer{background:var(--corbata-dim);border:1px solid rgba(200,37,28,0.3);color:var(--corbata);}

    /* ‚ïê‚ïê INFO BOXES ‚ïê‚ïê */
    .info-box{border-radius:2px 4px 3px 3px;padding:7px 9px;font-family:var(--font-mono);font-size:9px;line-height:1.7;}
    .info-box a{color:inherit;}
    .info-red   {background:var(--corbata-soft);border:1px solid rgba(200,37,28,0.4);color:var(--corbata);}
    .info-yellow{background:rgba(180,130,30,0.12);border:1px solid rgba(180,130,30,0.3);color:#c8a040;}
    .info-green {background:rgba(222,218,212,0.08);border:1px solid rgba(222,218,212,0.2);color:var(--camisa-dim);}

    .url-box{
      background:var(--traje);border:1px solid rgba(10,8,6,0.4);
      border-radius:2px 4px 3px 3px;padding:6px 9px;
      font-family:monospace;font-size:9.5px;color:var(--camisa-dim);
      word-break:break-all;cursor:pointer;transition:all 0.15s;line-height:1.5;opacity:0.8;
    }
    .url-box:hover{border-color:var(--corbata);opacity:1;}
    .hint{font-family:var(--font-mono);font-size:8.5px;color:var(--camisa-muted);line-height:1.6;}
    .font-preview{
      padding:6px 9px;background:var(--traje-light);border:1px solid rgba(10,8,6,0.4);
      border-radius:2px;font-size:13px;color:var(--camisa);
      text-align:center;min-height:30px;display:flex;align-items:center;justify-content:center;
    }
    .config-row{display:flex;align-items:center;gap:8px;}
    .value-display{font-family:var(--font-mono);color:var(--camisa);font-size:9.5px;min-width:32px;}
    input[type=range]{width:100%;cursor:pointer;-webkit-appearance:none;appearance:none;height:2px;background:rgba(222,218,212,0.15);border-radius:1px;outline:none;border:none;}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--corbata);cursor:pointer;border:2px solid var(--guante);box-shadow:1px 1px 0 rgba(10,8,6,0.3);}
    input[type=color]{width:32px;height:24px;border:1px solid rgba(200,37,28,0.4);border-radius:2px;cursor:pointer;background:transparent;padding:1px;}
    .separator{border-top:1px solid rgba(200,37,28,0.15);margin:5px 0;}

    /* ‚ïê‚ïê MAIN / CHAT ‚Äî gris checker medio ‚ïê‚ïê */
    .main{flex:1;min-width:0;display:flex;flex-direction:column;overflow:hidden;background:var(--checker-mid);position:relative;}

    /* L√≠neas de papel gris */
    .main::before{
      content:'';position:absolute;inset:0;pointer-events:none;z-index:0;
      background-image:repeating-linear-gradient(
        to bottom,transparent,transparent 29px,
        rgba(10,8,6,0.1) 29px,rgba(10,8,6,0.1) 30px
      );
    }

    .chat-panel{
      flex:1;overflow-y:auto;overflow-x:hidden;
      padding:13px 15px;display:flex;flex-direction:column;gap:5px;
      position:relative;z-index:1;
    }
    .chat-panel::-webkit-scrollbar{width:3px;}
    .chat-panel::-webkit-scrollbar-track{background:transparent;}
    .chat-panel::-webkit-scrollbar-thumb{background:rgba(10,8,6,0.25);border-radius:2px;}
    .chat-panel::-webkit-scrollbar-thumb:hover{background:rgba(200,37,28,0.4);}
    .chat-spacer{flex:1;min-height:0;}

    #chat-placeholder{
      text-align:center;color:rgba(10,8,6,0.4);
      font-family:var(--font-title);font-size:14px;font-style:italic;
      padding:70px 20px;letter-spacing:2px;line-height:2.8;
    }

    /* ‚ïê‚ïê MENSAJES ‚Äî sobre fondo checker gris ‚ïê‚ïê */
    .msg-item{
      position:relative;display:flex;align-items:flex-start;gap:9px;
      padding:8px 11px;
      background:var(--checker-light);
      border-top:  1.5px solid rgba(10,8,6,0.22);
      border-left: 3px   solid rgba(10,8,6,0.22);
      border-right:1px   solid rgba(10,8,6,0.08);
      border-bottom:1px  solid rgba(10,8,6,0.08);
      border-radius:1px 4px 3px 2px;
      cursor:pointer;
      animation:msgIn 0.25s cubic-bezier(0.2,0.9,0.3,1);
      transition:background 0.14s,border-left-color 0.14s,transform 0.12s,box-shadow 0.12s;
      flex-shrink:0;box-shadow:var(--shadow);
    }
    @keyframes msgIn{from{opacity:0;transform:translateX(-9px);}to{opacity:1;transform:translateX(0);}}
    .msg-item:hover{background:var(--checker-pale);border-left-color:var(--corbata);transform:translateX(2px);box-shadow:3px 4px 0 rgba(10,8,6,0.2);}
    .msg-item.twitch {border-left-color:rgba(10,8,6,0.3);}
    .msg-item.kick   {border-left-color:rgba(10,8,6,0.25);}
    .msg-item.tiktok {border-left-color:rgba(10,8,6,0.2);}
    .msg-item.youtube{border-left-color:rgba(10,8,6,0.15);}
    .msg-item.custom {border-left-color:rgba(200,37,28,0.4);}
    .msg-item.system {border-left-color:rgba(200,37,28,0.6);}
    .msg-item.highlighted{
      background:rgba(200,37,28,0.12);
      border-left:3px solid var(--corbata)!important;
      border-color:rgba(200,37,28,0.25);
      box-shadow:0 0 0 2px rgba(200,37,28,0.12),var(--shadow);
      animation:msgIn 0.25s cubic-bezier(0.2,0.9,0.3,1),hlPulse 3s ease-in-out infinite;
    }
    @keyframes hlPulse{0%,100%{box-shadow:0 0 0 2px rgba(200,37,28,0.12);}50%{box-shadow:0 0 0 5px rgba(200,37,28,0.06);}}

    .chat-panel.single-line .msg-item{align-items:center;padding:5px 11px;gap:7px;}
    .chat-panel.single-line .msg-avatar{width:20px!important;height:20px!important;min-width:20px;}
    .chat-panel.single-line .msg-body{display:flex;align-items:center;gap:5px;flex:1;min-width:0;overflow:hidden;}
    .chat-panel.single-line .msg-header{display:contents;}
    .chat-panel.single-line .msg-time{display:none;}
    .chat-panel.single-line .msg-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    .msg-avatar{
      width:32px;height:32px;border-radius:50%;
      border:1.5px solid rgba(10,8,6,0.3);flex-shrink:0;
      overflow:hidden;background:var(--checker-dark);
      filter:grayscale(55%);box-shadow:1px 1px 0 rgba(10,8,6,0.2);
    }
    .msg-avatar img{width:100%;height:100%;object-fit:cover;display:block;}
    .msg-avatar-fallback{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:12px;opacity:0.35;}
    .msg-body{flex:1;min-width:0;}
    .msg-header{display:flex;align-items:center;gap:5px;margin-bottom:2px;flex-wrap:wrap;}
    .msg-user{font-family:var(--font-title);font-size:13px;color:var(--traje);letter-spacing:0.3px;white-space:nowrap;}
    .msg-platform{
      display:inline-flex;align-items:center;gap:2px;
      font-family:var(--font-mono);font-size:7.5px;padding:1px 5px;border-radius:2px;
      font-weight:700;letter-spacing:0.5px;
      background:rgba(10,8,6,0.12);border:1px solid rgba(10,8,6,0.2);color:var(--traje-light);
    }
    .msg-platform svg{width:8px;height:8px;flex-shrink:0;}
    .msg-badge{height:13px;width:auto;vertical-align:middle;filter:grayscale(100%);}
    .msg-time{font-family:var(--font-mono);font-size:8.5px;color:rgba(10,8,6,0.45);margin-left:auto;white-space:nowrap;}
    .msg-text{font-size:13px;color:var(--traje);line-height:1.55;word-break:break-word;font-family:var(--font-body);}
    .msg-text img.emote{height:var(--ov-emote-size,24px);width:auto;vertical-align:middle;margin:0 2px;filter:grayscale(60%);}
    .msg-role{font-family:var(--font-mono);font-size:7.5px;padding:1px 4px;background:rgba(10,8,6,0.1);border:1px solid rgba(10,8,6,0.2);border-radius:2px;color:var(--traje-light);letter-spacing:0.5px;}
    .msg-highlight-btn{
      margin-left:auto;padding:2px 7px;font-size:7.5px;border-radius:2px;
      border:1px solid rgba(200,37,28,0.3);background:var(--corbata-dim);
      color:var(--corbata);cursor:pointer;display:none;
      font-family:var(--font-mono);font-weight:700;letter-spacing:0.5px;text-transform:uppercase;transition:all 0.12s;
    }
    .msg-highlight-btn:hover{background:var(--corbata);color:var(--camisa);border-color:var(--corbata);}
    .msg-item:hover .msg-highlight-btn,.msg-item.highlighted .msg-highlight-btn{display:inline-block;}
    .msg-donation-tag{
      margin-top:4px;padding:3px 9px;
      background:var(--corbata-soft);border:1px solid rgba(200,37,28,0.3);
      border-radius:2px;font-family:var(--font-mono);font-size:8.5px;font-weight:700;
      color:var(--corbata);text-align:center;text-transform:uppercase;letter-spacing:1.5px;
    }

    #hl-bar{
      padding:7px 14px;background:rgba(200,37,28,0.1);
      border-top:1px solid rgba(200,37,28,0.25);
      display:none;align-items:center;gap:9px;
      font-family:var(--font-mono);font-size:8.5px;color:var(--corbata);
      letter-spacing:0.5px;text-transform:uppercase;z-index:1;position:relative;
    }
    #hl-bar.active{display:flex;}
    #hl-bar strong{color:var(--traje);max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:var(--font-body);font-size:12px;text-transform:none;font-weight:400;}

    /* Input bar negro traje, borde rojo arriba */
    .input-bar{
      padding:9px 13px;
      border-top:2px solid var(--corbata);
      background:var(--traje);
      display:flex;gap:7px;position:relative;z-index:1;
    }
    .input-bar input[type=text]{
      background:var(--traje-light);color:var(--camisa);
    }

    /* ‚ïê‚ïê MODAL ‚ïê‚ïê */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(10,8,6,0.7);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
    .modal-overlay.open{display:flex;}
    .modal-box{
      background:var(--traje-light);
      border-top:2px solid var(--corbata);
      border-left:2px solid rgba(10,8,6,0.5);
      border-right:1.5px solid rgba(10,8,6,0.2);
      border-bottom:1.5px solid rgba(10,8,6,0.2);
      border-radius:2px 6px 4px 5px;padding:26px;max-width:480px;width:90%;position:relative;
      box-shadow:5px 6px 0 rgba(10,8,6,0.3),0 20px 50px rgba(10,8,6,0.5);
    }
    .modal-title{font-family:var(--font-title);font-size:16px;color:var(--camisa);margin-bottom:14px;letter-spacing:1px;}
    .modal-close{position:absolute;top:11px;right:13px;background:none;border:none;color:var(--camisa-muted);font-size:17px;cursor:pointer;}
    .modal-close:hover{color:var(--corbata);}
    .modal-box ol{padding-left:17px;line-height:2.3;font-size:11.5px;color:var(--camisa-dim);font-family:var(--font-mono);}
    .modal-box ol strong{color:var(--camisa);}
    .modal-box code{background:var(--traje);border:1px solid rgba(10,8,6,0.4);padding:2px 6px;border-radius:2px;font-size:10.5px;color:var(--camisa);}

    /* ‚ïê‚ïê TOAST ‚ïê‚ïê */
    #toast{
      position:fixed;bottom:18px;left:50%;
      transform:translateX(-50%) translateY(50px);
      background:var(--corbata);color:var(--camisa);
      padding:8px 16px;border-radius:2px 4px 3px 3px;
      font-family:var(--font-mono);font-size:9.5px;letter-spacing:0.8px;text-transform:uppercase;
      z-index:999;opacity:0;
      transition:all 0.28s cubic-bezier(0.34,1.56,0.64,1);
      pointer-events:none;white-space:nowrap;
      box-shadow:3px 4px 0 rgba(10,8,6,0.35);
    }
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  </style>
</head>
<body>

<div class="particles" id="particles"></div>

<header>
  <div class="header-left">
    <img class="logo-img"
      src="https://i.ibb.co/7xhK7QHb/279-sin-t-tulo-20250219223210.png"
      alt="Meeve" onerror="this.style.display='none'" />
    <div class="header-text">
      <div class="header-title">Meeve</div>
      <div class="header-subtitle">multichat dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <div id="ws-dot"></div>
    <span id="ws-label">Desconectado</span>
  </div>
</header>

<div class="layout">
  <button id="sidebar-toggle" onclick="toggleSidebar()" title="Panel">
    <span class="toggle-arrow">‚óÄ</span>
  </button>

  <div class="sidebar">
    <div class="card">
      <div class="card-title">‚óã Servidor</div>
      <label>URL del servidor</label>
      <div class="input-row" style="margin-bottom:5px;">
        <input id="serverUrl" type="text" placeholder="wss://tu-app.onrender.com" />
        <button class="btn btn-primary" onclick="saveAndConnect()">Conectar</button>
      </div>
      <div class="hint">Se guarda en el navegador autom√°ticamente</div>
    </div>

    <div class="card">
      <div class="card-title">‚óé Estado Conexiones</div>
      <div class="platform-row">
        <span class="platform-dot" id="dot-twitch"></span>
        <span class="platform-icon">üü£</span>
        <div class="platform-info"><div class="platform-name">Twitch</div><div class="platform-channel" id="ch-twitch">‚Äî</div></div>
      </div>
      <div class="platform-row">
        <span class="platform-dot" id="dot-kick"></span>
        <span class="platform-icon">üü¢</span>
        <div class="platform-info"><div class="platform-name">Kick</div><div class="platform-channel" id="ch-kick">‚Äî</div></div>
      </div>
      <div class="platform-row">
        <span class="platform-dot" id="dot-tiktok"></span>
        <span class="platform-icon">üéµ</span>
        <div class="platform-info"><div class="platform-name">TikTok</div><div class="platform-channel" id="ch-tiktok">‚Äî</div></div>
        <span id="tiktok-mode-tag" class="tag tag-connector">connector</span>
      </div>
      <div class="platform-row">
        <span class="platform-dot" id="dot-youtube"></span>
        <span class="platform-icon">‚ñ∂Ô∏è</span>
        <div class="platform-info"><div class="platform-name">YouTube</div><div class="platform-channel" id="ch-youtube">‚Äî</div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">‚óâ Kick ‚Äî Chatroom</div>
      <div id="kick-status-box" class="info-box info-green" style="margin-bottom:8px;">Kick bloquea servidores. El navegador act√∫a como puente.</div>
      <div class="btn-row">
        <button class="btn btn-secondary btn-full" onclick="resolveKickId()">üîç Autom√°tico</button>
        <button class="btn btn-secondary btn-full" onclick="toggleKickManual()">‚úè Manual</button>
      </div>
      <div id="kick-manual-wrap" style="display:none;margin-top:8px;">
        <label>Kick Channel ID</label>
        <div class="input-row">
          <input id="kickChannelId" type="text" placeholder="ej: 1234567" />
          <button class="btn btn-primary" onclick="sendKickId()">OK</button>
        </div>
        <div class="hint">F12 ‚Üí Network ‚Üí chatrooms.XXXXXX</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">‚óé TikTok</div>
      <div class="btn-row" style="margin-bottom:8px;">
        <button class="btn btn-secondary btn-full" onclick="restartTikTok()">‚Ü∫ Reconectar</button>
        <button class="btn btn-secondary btn-full" onclick="openTikTokLive()">‚ñ∂ Live</button>
      </div>
      <div class="info-box info-red">Error 403: <a href="#" onclick="openModal('tiktok-modal');return false;">usar SESSION_ID</a></div>
    </div>

    <div class="card">
      <div class="card-title">‚óã YouTube</div>
      <div id="youtube-status-box" class="info-box info-yellow" style="margin-bottom:8px;">‚è≥ Esperando conexi√≥n...</div>
      <div class="btn-row">
        <button class="btn btn-secondary btn-full" onclick="restartYouTube()">‚Ü∫ Reconectar</button>
        <button class="btn btn-secondary btn-full" onclick="openYouTubeLive()">‚ñ∂ Live</button>
      </div>
      <div class="hint" style="margin-top:5px;">Reconectar al encender el directo.</div>
    </div>

    <div class="card">
      <div class="card-title">‚óé URLs para OBS</div>
      <label>üí¨ Chat multichat</label>
      <div class="url-box" id="url-chat" onclick="copyUrl('url-chat')" title="Click para copiar">Configura el servidor...</div>
      <div class="btn-row" style="margin:4px 0 8px;">
        <button class="btn btn-secondary btn-full" style="font-size:8.5px;padding:4px;" onclick="copyUrl('url-chat')">Copiar</button>
        <button class="btn btn-secondary btn-full" style="font-size:8.5px;padding:4px;" onclick="openUrl('url-chat')">Abrir</button>
      </div>
      <label>üó® Chat un mensaje</label>
      <div class="url-box" id="url-chatuno" onclick="copyUrl('url-chatuno')" title="Click para copiar">Configura el servidor...</div>
      <div class="btn-row" style="margin:4px 0 8px;">
        <button class="btn btn-secondary btn-full" style="font-size:8.5px;padding:4px;" onclick="copyUrl('url-chatuno')">Copiar</button>
        <button class="btn btn-secondary btn-full" style="font-size:8.5px;padding:4px;" onclick="openUrl('url-chatuno')">Abrir</button>
      </div>
      <label>üìå Destacador</label>
      <div class="url-box" id="url-destacador" onclick="copyUrl('url-destacador')" title="Click para copiar">Configura el servidor...</div>
      <div class="btn-row" style="margin:4px 0 6px;">
        <button class="btn btn-secondary btn-full" style="font-size:8.5px;padding:4px;" onclick="copyUrl('url-destacador')">Copiar</button>
        <button class="btn btn-secondary btn-full" style="font-size:8.5px;padding:4px;" onclick="openUrl('url-destacador')">Abrir</button>
      </div>
      <div class="hint">Tiempo visible: <input id="showtime-input" type="number" style="width:42px;padding:2px 4px;font-size:8.5px;" value="12" min="1" max="120" onchange="updateOverlayUrls()"> seg</div>
    </div>

    <div class="card">
      <div class="card-title">‚óë Configuraci√≥n Visual</div>
      <label>Fuente del dashboard</label>
      <select id="fontSelector" onchange="applyFont(this.value)" style="margin-bottom:6px;">
        <option value="'Crimson Pro', serif">Crimson Pro (por defecto)</option>
        <option value="'Libre Baskerville', serif">Libre Baskerville</option>
        <option value="'Zen Antique', serif">Zen Antique</option>
        <option value="'Special Elite', monospace">Special Elite ‚Äî M√°quina</option>
        <option value="'Rajdhani', sans-serif">Rajdhani</option>
        <option value="'Orbitron', sans-serif">Orbitron ‚Äî Cyberpunk</option>
        <option value="'Share Tech Mono', monospace">Share Tech Mono</option>
        <option value="'VT323', monospace">VT323 ‚Äî Retro</option>
        <option value="'Exo 2', sans-serif">Exo 2</option>
        <option value="'Russo One', sans-serif">Russo One</option>
        <option value="'Michroma', sans-serif">Michroma</option>
        <option value="'Nova Square', sans-serif">Nova Square</option>
      </select>
      <div class="font-preview" id="font-preview">Meeve Dashboard ‚Äî Preview 123</div>
      <div class="separator" style="margin:7px 0;"></div>
      <div class="toggle-row">
        <span class="toggle-label">Brillo / glow</span>
        <label class="toggle-switch"><input type="checkbox" id="glowToggle" checked onchange="toggleGlow(this.checked)"><span class="toggle-slider"></span></label>
      </div>
      <div class="toggle-row">
        <span class="toggle-label">Modo l√≠nea √∫nica</span>
        <label class="toggle-switch"><input type="checkbox" id="singleLineToggle" onchange="toggleSingleLine(this.checked)"><span class="toggle-slider"></span></label>
      </div>
      <div class="separator" style="margin:7px 0;"></div>
      <label>Tama√±o emotes: <span class="value-display" id="val-emote">24px</span></label>
      <input type="range" id="emoteSize" min="16" max="60" value="24" oninput="setCfgVar('--ov-emote-size',this.value+'px','val-emote')" style="margin-bottom:6px;">
      <label>Tama√±o nombre: <span class="value-display" id="val-fontName">13px</span></label>
      <input type="range" id="fontNameSize" min="8" max="22" value="13" oninput="setMsgNameSize(this.value)" style="margin-bottom:6px;">
      <label>M√°x. mensajes: <span class="value-display" id="val-maxMsg">200</span></label>
      <input type="range" id="maxMsgRange" min="20" max="1000" value="200" step="10" oninput="document.getElementById('val-maxMsg').textContent=this.value;MAX_MESSAGES=parseInt(this.value);" style="margin-bottom:6px;">
      <label>Color acento:</label>
      <div class="config-row" style="margin-bottom:8px;">
        <input type="color" id="colorPrimary" value="#c8251c" oninput="applyColorPrimary(this.value)">
        <span class="hint">Color de acento (corbata)</span>
      </div>
      <div class="separator" style="margin:4px 0 8px;"></div>
      <button class="btn btn-danger btn-full" style="margin-bottom:5px;" onclick="clearChat()">Limpiar chat</button>
      <button class="btn btn-secondary btn-full" onclick="exportMessages()">Exportar mensajes</button>
    </div>
  </div>

  <div class="main">
    <div class="chat-panel" id="chat-panel">
      <div class="chat-spacer" id="chat-spacer"></div>
      <div id="chat-placeholder">Los mensajes aparecer√°n aqu√≠<br><span style="font-size:11px;letter-spacing:3px;">‚Äî „Å≤„Å®„Å§„ÇÅÊßò ‚Äî</span></div>
    </div>
    <div id="hl-bar">
      üìå Destacando:&nbsp;<strong id="hl-bar-text">‚Äî</strong>
      <button class="btn btn-secondary" style="font-size:8.5px;padding:3px 8px;margin-left:auto;" onclick="clearHighlight()">‚úï Quitar</button>
    </div>
    <div class="input-bar">
      <input id="custom-msg-input" type="text" placeholder="Escribe un mensaje personalizado y pulsa Enter‚Ä¶" onkeydown="if(event.key==='Enter')sendCustomMessage()" />
      <button class="btn btn-primary" onclick="sendCustomMessage()">Enviar</button>
      <button class="btn btn-secondary" onclick="injectTestMessage()" title="Mensaje de prueba">üß™</button>
    </div>
  </div>
</div>

<div id="tiktok-modal" class="modal-overlay">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('tiktok-modal')">‚úï</button>
    <div class="modal-title">Obtener TIKTOK_SESSION_ID</div>
    <ol>
      <li>Abre <strong>tiktok.com</strong> en Chrome e inicia sesi√≥n</li>
      <li>Pulsa <strong>F12</strong> ‚Üí pesta√±a <strong>Application</strong></li>
      <li>Panel: <strong>Cookies ‚Üí https://www.tiktok.com</strong></li>
      <li>Busca la cookie <strong>sessionid</strong> ‚Üí copia el valor</li>
      <li>En Render/Railway:<br><code>TIKTOK_SESSION_ID = (el valor)</code></li>
      <li>Reinicia el servidor</li>
    </ol>
    <p style="margin-top:11px;" class="hint">‚ö† El sessionid caduca cada ~30 d√≠as.</p>
  </div>
</div>

<div id="toast"></div>

<script>
(function(){var c=document.getElementById('particles');for(var i=0;i<16;i++){var p=document.createElement('div');p.className='particle';var s=Math.random()>0.45;p.style.cssText=['left:'+(Math.random()*100)+'%','width:'+(s?(Math.random()*0.7+0.3):(Math.random()*2+0.6))+'px','height:'+(s?(Math.random()*12+4):(Math.random()*2+1))+'px','animation-duration:'+(Math.random()*30+25)+'s','animation-delay:'+(Math.random()*22)+'s','--r:'+(Math.random()*40-20)+'deg'].join(';');c.appendChild(p);}})();

var store={get:function(k,d){try{return localStorage.getItem(k)||d||'';}catch(e){return d||'';}},set:function(k,v){try{localStorage.setItem(k,v);}catch(e){}}};
var ws=null,retryDelay=1000,isConnected=false,autoKickDone=false;
var currentChannels={twitch:'',kick:'',tiktok:'',youtube:''};
var MAX_MESSAGES=200,messages=[],currentHighlightMid=null,autoScroll=true;

var LOGOS={twitch:'<svg viewBox="0 0 24 28" fill="currentColor"><path d="M2.149 0L.537 4.119v19.63h6.72V28l4.123-4.25h3.29L22.463 14V0H2.149zm18.24 13.18l-3.29 3.387h-3.948l-2.886 2.973v-2.973H6.584V2.387h13.805v10.793zM17.07 5.367h-2.148v6.42h2.148V5.367zm-5.907 0h-2.15v6.42h2.15V5.367z"/></svg>',kick:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 3h4v7l4.5-7H17L12 12l5.5 9H13L8.5 14v7H4V3z"/></svg>',tiktok:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-2.88 2.5 2.89 2.89 0 0 1-2.89-2.89 2.89 2.89 0 0 1 2.89-2.89c.28 0 .54.04.79.1V9.01a6.33 6.33 0 0 0-.79-.05 6.34 6.34 0 0 0-6.34 6.34 6.34 6.34 0 0 0 6.34 6.34 6.34 6.34 0 0 0 6.33-6.34V9.05a8.16 8.16 0 0 0 4.77 1.52V7.12a4.85 4.85 0 0 1-1-.43z"/></svg>',youtube:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.495 6.205a3.007 3.007 0 0 0-2.088-2.088c-1.87-.501-9.396-.501-9.396-.501s-7.507-.01-9.396.501A3.007 3.007 0 0 0 .527 6.205a31.247 31.247 0 0 0-.522 5.805 31.247 31.247 0 0 0 .522 5.783 3.007 3.007 0 0 0 2.088 2.088c1.868.502 9.396.502 9.396.502s7.506 0 9.396-.502a3.007 3.007 0 0 0 2.088-2.088 31.247 31.247 0 0 0 .5-5.783 31.247 31.247 0 0 0-.5-5.805zM9.609 15.601V8.408l6.264 3.602z"/></svg>',custom:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',system:'<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>'};

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function processTwitchEmotes(t,e){if(!e||!e.length)return esc(t);var s=e.slice().sort(function(a,b){return a.start-b.start;}),r='',c=0;for(var i=0;i<s.length;i++){var x=s[i];if(x.start>c)r+=esc(t.slice(c,x.start));r+='<img class="emote" src="'+esc(x.url)+'" alt="'+esc(x.text)+'" onerror="this.style.display=\'none\'">';c=x.end+1;}if(c<t.length)r+=esc(t.slice(c));return r;}
function parseKickEmotes(t){return esc(t).replace(/\[emote:(\d+):([^\]]+)\]/g,function(m,id,n){return '<img class="emote" src="https://files.kick.com/emotes/'+id+'/fullsize" alt="'+n+'" onerror="this.style.display=\'none\'">';});}
function processMessageHTML(d){var t=d.chatmessage||'',p=d.platform||d.type||'';if(p==='twitch'&&d.chatemotes&&d.chatemotes.length)return processTwitchEmotes(t,d.chatemotes);if(p==='kick')return parseKickEmotes(t);return esc(t);}

function toggleSidebar(){var s=document.querySelector('.sidebar'),b=document.getElementById('sidebar-toggle');var c=s.classList.toggle('collapsed');b.classList.toggle('collapsed',c);store.set('sidebarCollapsed',c?'1':'0');}

document.addEventListener('DOMContentLoaded',function(){
  document.getElementById('serverUrl').value=store.get('serverUrl');updateOverlayUrls();
  if(store.get('serverUrl'))connectWS(store.get('serverUrl'));
  if(store.get('sidebarCollapsed')==='1'){document.querySelector('.sidebar').classList.add('collapsed');document.getElementById('sidebar-toggle').classList.add('collapsed');}
  var sf=store.get('chatFont');if(sf){var sel=document.getElementById('fontSelector');for(var i=0;i<sel.options.length;i++){if(sel.options[i].value===sf){sel.selectedIndex=i;break;}}applyFont(sf,true);}
  if(store.get('glowOff')==='1'){document.getElementById('glowToggle').checked=false;toggleGlow(false,true);}
  if(store.get('singleLine')==='1'){document.getElementById('singleLineToggle').checked=true;toggleSingleLine(true,true);}
  var sc=store.get('accentColor');if(sc){document.getElementById('colorPrimary').value=sc;applyColorPrimary(sc,true);}
  var se=store.get('emoteSize');if(se){document.getElementById('emoteSize').value=se;setCfgVar('--ov-emote-size',se+'px','val-emote');}
  var sm=store.get('maxMsg');if(sm){var n=parseInt(sm);MAX_MESSAGES=n;document.getElementById('maxMsgRange').value=n;document.getElementById('val-maxMsg').textContent=n;}
  document.getElementById('chat-panel').addEventListener('scroll',function(){autoScroll=(this.scrollHeight-this.scrollTop-this.clientHeight)<80;});
});

function applyFont(v,s){document.documentElement.style.setProperty('--font-body',v);document.getElementById('font-preview').style.fontFamily=v;store.set('chatFont',v);if(!s)toast('Fuente cambiada');}
function toggleGlow(e,s){store.set('glowOff',e?'0':'1');if(e){document.body.classList.remove('no-glow');if(!s)toast('Brillo activado');}else{document.body.classList.add('no-glow');if(!s)toast('Brillo desactivado');}}
function toggleSingleLine(e,s){store.set('singleLine',e?'1':'0');var p=document.getElementById('chat-panel');if(e){p.classList.add('single-line');if(!s)toast('L√≠nea √∫nica activado');}else{p.classList.remove('single-line');if(!s)toast('Modo normal');}}
function setCfgVar(cv,v,did){document.documentElement.style.setProperty(cv,v);if(did)document.getElementById(did).textContent=v;if(cv==='--ov-emote-size')store.set('emoteSize',parseInt(v));}
function setMsgNameSize(v){document.getElementById('val-fontName').textContent=v+'px';var el=document.getElementById('dyn-name');if(!el){el=document.createElement('style');el.id='dyn-name';document.head.appendChild(el);}el.textContent='.msg-user{font-size:'+v+'px!important;}';}
function applyColorPrimary(v,s){document.documentElement.style.setProperty('--corbata',v);if(!s){store.set('accentColor',v);toast('Color aplicado');}}

function connectWS(url){if(!url)return;if(ws){try{ws.close();}catch(e){}}var wu=url.replace(/^https?/,'ws').replace(/\/$/,'');try{ws=new WebSocket(wu);}catch(e){setStatus(false);scheduleRetry(url);return;}ws.onopen=function(){isConnected=true;retryDelay=1000;setStatus(true);var id=store.get('kickChannelId');if(id)connectKickBrowser(id);};ws.onmessage=function(e){try{var d=JSON.parse(e.data);if(d.type==='status')handleStatus(d);else if(d.type==='highlight'||d.type==='highlight_clear')return;else appendMessage(d);}catch(err){}};ws.onclose=function(){isConnected=false;setStatus(false);scheduleRetry(url);};ws.onerror=function(){ws.close();};}
function scheduleRetry(url){retryDelay=Math.min(retryDelay*2,30000);setTimeout(function(){connectWS(url);},retryDelay);}
function setStatus(ok){document.getElementById('ws-dot').className=ok?'ok':'';document.getElementById('ws-label').textContent=ok?'Conectado':'Desconectado';}
function handleStatus(data){setPlatformStatus('twitch',data.twitch,(data.channels&&data.channels.twitch)||'‚Äî');setPlatformStatus('kick',data.kick,(data.channels&&data.channels.kick)||'‚Äî');setPlatformStatus('tiktok',data.tiktok,(data.channels&&data.channels.tiktok)||'‚Äî');setPlatformStatus('youtube',data.youtube,(data.channels&&data.channels.youtube)||'‚Äî');if(data.channels)currentChannels=data.channels;var mt=document.getElementById('tiktok-mode-tag');if(mt){mt.textContent=data.tiktokMode||'connector';mt.className='tag '+(data.tiktokMode==='puppeteer'?'tag-puppeteer':'tag-connector');}var ytBox=document.getElementById('youtube-status-box');if(ytBox){if(data.youtube){ytBox.className='info-box info-green';ytBox.innerHTML='‚úì Conectado al chat en vivo';}else if(data.channels&&data.channels.youtube){ytBox.className='info-box info-yellow';ytBox.innerHTML='‚è≥ '+esc(data.channels.youtube)+' ‚Äî Sin live activo.';}else{ytBox.className='info-box info-red';ytBox.innerHTML='Configura YOUTUBE_HANDLE en el servidor.';}}if(!data.kick){var sid=store.get('kickChannelId');if(sid&&(!kickWs||kickWs.readyState>1))connectKickBrowser(sid);else if(!sid&&!autoKickDone&&data.channels&&data.channels.kick){autoKickDone=true;setTimeout(resolveKickId,1500);}}}
function setPlatformStatus(p,c,ch){var dot=document.getElementById('dot-'+p),el=document.getElementById('ch-'+p);if(dot)dot.className='platform-dot'+(c?' ok':'');if(el)el.textContent=ch||'‚Äî';}

function appendMessage(data){
  if(!data.chatname&&!data.chatmessage)return;
  var panel=document.getElementById('chat-panel');var ph=document.getElementById('chat-placeholder');if(ph)ph.remove();
  var platform=data.platform||data.type||'custom';var logo=LOGOS[platform]||LOGOS.custom;
  var time=new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
  var el=document.createElement('div');el.className='msg-item '+platform;el.dataset.mid=data.mid||'';
  var aHTML=data.chatimg?'<div class="msg-avatar"><img src="'+esc(data.chatimg)+'" onerror="this.parentNode.innerHTML=\'<div class=msg-avatar-fallback>'+logo+'</div>\'"></div>':'<div class="msg-avatar"><div class="msg-avatar-fallback">'+logo+'</div></div>';
  var pLabel=platform.charAt(0).toUpperCase()+platform.slice(1);
  var pBadge='<span class="msg-platform"><span style="width:8px;height:8px;display:inline-flex;opacity:0.5;">'+logo+'</span>'+pLabel+'</span>';
  var bHTML='';if(data.roles&&data.roles.length)data.roles.forEach(function(r){bHTML+='<span class="msg-role">'+esc(r.label||r.type)+'</span>';});
  var nStyle=data.nameColor?'filter:grayscale(100%) brightness(0.5);color:'+data.nameColor+';':'';
  var mHTML=processMessageHTML(data);var dHTML='';
  if(data.type==='donation'&&(data.amount||data.donationType)){var dl=data.donationType==='bits'?'üíé '+data.amount+' Bits':data.donationType==='sub'?'‚òÖ Nuevo Sub':data.donationType==='resub'?'‚Ü∫ '+data.months+' meses':data.donationType==='subgift'?'‚ú¶ Sub regalada':data.donationType==='superchat'?'‚ú¶ '+(data.amountDisplay||data.amount):data.donationType==='member'?'‚òÖ Nuevo Miembro':data.donationType==='gift'?'‚ú¶ Regalo TikTok':data.amount?'‚ú¶ '+data.amount:'';if(dl)dHTML='<div class="msg-donation-tag">'+dl+'</div>';}
  el.innerHTML=aHTML+'<div class="msg-body"><div class="msg-header"><span class="msg-user" style="'+nStyle+'">'+esc(data.chatname||'?')+'</span>'+pBadge+bHTML+'<span class="msg-time">'+time+'</span><button class="msg-highlight-btn" onclick="event.stopPropagation();sendHighlight(this.closest(\'.msg-item\'))">üìå Destacar</button></div><div class="msg-text">'+mHTML+'</div>'+dHTML+'</div>';
  el._msgData=data;el.addEventListener('click',function(){sendHighlight(el);});
  panel.appendChild(el);messages.push({el:el,data:data});
  if(messages.length>MAX_MESSAGES){var old=messages.shift();if(old.el.parentNode)old.el.parentNode.removeChild(old.el);}
  if(autoScroll)requestAnimationFrame(function(){panel.scrollTop=panel.scrollHeight;});
}
function sendHighlight(el){if(!isConnected||!ws)return toast('Sin conexi√≥n');var data=el._msgData;if(!data)return;document.querySelectorAll('.msg-item.highlighted').forEach(function(m){m.classList.remove('highlighted');});el.classList.add('highlighted');currentHighlightMid=el.dataset.mid;document.getElementById('hl-bar').classList.add('active');document.getElementById('hl-bar-text').textContent=(data.chatname||'?')+': '+(data.chatmessage||'');ws.send(JSON.stringify({type:'highlight',platform:data.platform||data.type||'custom',chatname:data.chatname||'',chatmessage:data.chatmessage||'',chatimg:data.chatimg||null,nameColor:data.nameColor||null,roles:data.roles||[],chatemotes:data.chatemotes||[],mid:data.mid||''}));toast('üìå Mensaje destacado');}
function clearHighlight(){if(!isConnected||!ws)return;ws.send(JSON.stringify({type:'highlight_clear'}));document.querySelectorAll('.msg-item.highlighted').forEach(function(m){m.classList.remove('highlighted');});currentHighlightMid=null;document.getElementById('hl-bar').classList.remove('active');toast('Destacado quitado');}

var kickWs=null,kickRetryDelay=3000,kickRetryTimeout=null;
function connectKickBrowser(channelId){if(!channelId)return;if(kickWs){try{kickWs.onmessage=null;kickWs.onclose=null;kickWs.onerror=null;kickWs.close();}catch(e){}kickWs=null;}if(kickRetryTimeout){clearTimeout(kickRetryTimeout);kickRetryTimeout=null;}var box=document.getElementById('kick-status-box');if(box){box.className='info-box info-yellow';box.innerHTML='‚è≥ Conectando a Kick...';}var urls=['wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false','wss://ws-us2.pusher.com/app/eb1d5f283081a78b932c?protocol=7&client=js&version=7.6.0&flash=false'];var idx=parseInt(localStorage.getItem('kickWsUrlIndex')||'0');tryKickUrl(channelId,urls,idx);}
function tryKickUrl(c,u,i){if(i>=u.length)i=0;try{kickWs=new WebSocket(u[i]);}catch(e){kickRetryTimeout=setTimeout(function(){tryKickUrl(c,u,(i+1)%u.length);},5000);return;}kickWs.onopen=function(){kickRetryDelay=3000;localStorage.setItem('kickWsUrlIndex',i);kickWs.send(JSON.stringify({event:'pusher:subscribe',data:{auth:'',channel:'chatrooms.'+c+'.v2'}}));};kickWs.onmessage=function(e){try{var msg=JSON.parse(e.data),ev=msg.event||'';if(ev==='pusher:connection_established'||ev==='pusher:pong')return;if(ev==='pusher_internal:subscription_succeeded'){var box=document.getElementById('kick-status-box');if(box){box.className='info-box info-green';box.innerHTML='‚úì Kick conectado (chatroom '+c+')';}if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'kick_connected'}));return;}if(ev==='pusher:error'){kickWs.close();return;}if(ev.indexOf('ChatMessageEvent')===-1)return;var d=typeof msg.data==='string'?JSON.parse(msg.data):msg.data;var kr=[],badges=(d.sender&&d.sender.identity&&d.sender.identity.badges)||[];badges.forEach(function(b){var bt=(b.type||'').toLowerCase();if(bt==='broadcaster'||bt==='owner')kr.push({type:'broadcaster',label:'Owner'});else if(bt==='moderator'||bt==='mod')kr.push({type:'moderator',label:'Mod'});else if(bt==='vip')kr.push({type:'vip',label:'VIP'});else if(bt==='subscriber'||bt==='sub')kr.push({type:'subscriber',label:'Sub'});else kr.push({type:bt,label:b.type});});var un=(d.sender&&d.sender.username)||'Unknown';var nc=(d.sender&&d.sender.identity&&d.sender.identity.color)||'#888';getKickAvatarBrowser(un,function(av){var cm={type:'kick_message',platform:'kick',chatname:un,chatmessage:d.content,nameColor:nc,chatimg:av||null,roles:kr,mid:d.id||('kick-'+Date.now())};if(ws&&ws.readyState===1)ws.send(JSON.stringify(cm));else appendMessage(cm);});}catch(err){}};kickWs.onclose=function(e){var box=document.getElementById('kick-status-box');if(box){box.className='info-box info-yellow';box.innerHTML='‚Ü∫ Kick desconectado...';}if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'kick_disconnected'}));var ni=e.code===4001?(i+1)%u.length:i;kickRetryDelay=Math.min(kickRetryDelay*1.5,30000);kickRetryTimeout=setTimeout(function(){tryKickUrl(c,u,ni);},kickRetryDelay);};kickWs.onerror=function(){};var pi=setInterval(function(){if(kickWs&&kickWs.readyState===1)kickWs.send(JSON.stringify({event:'pusher:ping',data:{}}));else clearInterval(pi);},25000);}
var kickAvatarCache={},kickAvatarPending={};
function getKickAvatarBrowser(username,cb){if(!username)return cb(null);var slug=username.toLowerCase();if(kickAvatarCache[slug])return cb(kickAvatarCache[slug]);if(kickAvatarPending[slug]){kickAvatarPending[slug].push(cb);return;}kickAvatarPending[slug]=[cb];fetch('https://kick.com/api/v2/channels/'+slug,{headers:{'Accept':'application/json'}}).then(function(r){return r.json();}).then(function(data){var av=(data.user&&(data.user.profile_pic||data.user.profilePic))||data.profile_pic||null;if(av)kickAvatarCache[slug]=av;var cbs=kickAvatarPending[slug]||[];delete kickAvatarPending[slug];cbs.forEach(function(c){c(av);});}).catch(function(){var cbs=kickAvatarPending[slug]||[];delete kickAvatarPending[slug];cbs.forEach(function(c){c(null);});});}

function saveAndConnect(){var url=document.getElementById('serverUrl').value.trim();if(!url)return toast('Introduce la URL');store.set('serverUrl',url);retryDelay=1000;autoKickDone=false;connectWS(url);updateOverlayUrls();toast('Conectando...');}
function toggleKickManual(){var el=document.getElementById('kick-manual-wrap');el.style.display=el.style.display==='none'?'block':'none';}
async function resolveKickId(){var channel=currentChannels.kick||store.get('kickChannel')||'';var box=document.getElementById('kick-status-box');if(!channel){box.className='info-box info-red';box.innerHTML='Sin KICK_CHANNEL configurado.';return;}box.className='info-box info-yellow';box.innerHTML='‚è≥ Resolviendo ID...';try{var r=await fetch('https://kick.com/api/v2/channels/'+channel,{headers:{'Accept':'application/json'}});if(!r.ok)throw new Error('HTTP '+r.status);var d=await r.json();var id=String((d.chatroom&&d.chatroom.id)||d.id||'');if(!id)throw new Error('Sin chatroom.id');box.className='info-box info-green';box.innerHTML='‚úì ID: <strong>'+id+'</strong>';document.getElementById('kickChannelId').value=id;await sendKickId(id);}catch(e){box.className='info-box info-red';box.innerHTML='Error: '+e.message;document.getElementById('kick-manual-wrap').style.display='block';}}
async function sendKickId(idParam){var id=idParam||document.getElementById('kickChannelId').value.trim();if(!id)return toast('Introduce el Channel ID');var su=store.get('serverUrl');if(!su)return toast('Conecta al servidor primero');var hu=su.replace(/^wss?/,'https').replace(/\/$/,'');try{var r=await fetch(hu+'/api/kick/channel-id',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({channelId:id})});var d=await r.json();if(d.ok){store.set('kickChannelId',String(id));toast('‚úì Kick ID '+id);connectKickBrowser(String(id));}else toast('Servidor rechaz√≥ el ID');}catch(e){toast('Error: '+e.message);}}
async function restartTikTok(){var su=store.get('serverUrl');if(!su)return toast('Configura la URL');var hu=su.replace(/^wss?/,'https').replace(/\/$/,'');try{var r=await fetch(hu+'/api/tiktok/restart',{method:'POST'});var d=await r.json();toast(d.ok?'‚Ü∫ TikTok reconectando...':'Error');}catch(e){toast('No se pudo conectar');}}
async function restartYouTube(){var su=store.get('serverUrl');if(!su)return toast('Configura la URL');var hu=su.replace(/^wss?/,'https').replace(/\/$/,'');var ytBox=document.getElementById('youtube-status-box');if(ytBox){ytBox.className='info-box info-yellow';ytBox.innerHTML='‚è≥ Buscando live...';}try{var r=await fetch(hu+'/api/youtube/restart',{method:'POST'});var d=await r.json();toast(d.ok?'‚Ü∫ YouTube reconectando...':'Error');}catch(e){toast('No se pudo conectar');}}
function openTikTokLive(){var u=currentChannels.tiktok||'';if(!u)return toast('TikTok no configurado');window.open('https://www.tiktok.com/@'+u+'/live','_blank','noopener');}
function openYouTubeLive(){var c=currentChannels.youtube||'';if(!c)return toast('YouTube no configurado');var h=c.startsWith('@')?c:'@'+c;window.open('https://www.youtube.com/'+h+'/live','_blank','noopener');}
function sendCustomMessage(){var input=document.getElementById('custom-msg-input'),text=input.value.trim();if(!text)return;if(!isConnected||!ws)return toast('Sin conexi√≥n');ws.send(JSON.stringify({type:'custom_message',user:'T√∫ (dashboard)',text:text}));input.value='';}
function getBaseOverlayDir(){var href=window.location.href.split('?')[0].replace(/\/+$/,'');var base=href.replace(/\/dashboard(\/[^?]*)?$/,'/overlay');if(base===href)base=href.replace(/\/[^/]+$/,'/overlay');return base;}
function updateOverlayUrls(){var su=store.get('serverUrl');var st=(parseInt(document.getElementById('showtime-input').value)||12)*1000;var base=(window.location.protocol!=='file:')?getBaseOverlayDir():'';var ids={'url-chat':{file:'index.html',params:''},'url-chatuno':{file:'chat_uno.html',params:''},'url-destacador':{file:'destacador.html',params:'&showtime='+st}};Object.keys(ids).forEach(function(id){var box=document.getElementById(id);if(!box)return;if(!su){box.textContent='Configura el servidor primero...';box.dataset.url='';return;}if(!base){box.textContent='No disponible en local';box.dataset.url='';return;}var url=base+'/'+ids[id].file+'?server='+encodeURIComponent(su)+ids[id].params;box.textContent=url;box.dataset.url=url;});}
function copyUrl(id){var url=document.getElementById(id).dataset.url;if(!url)return toast('Configura el servidor primero');navigator.clipboard.writeText(url).then(function(){toast('URL copiada');});}
function openUrl(id){var url=document.getElementById(id).dataset.url;if(!url)return toast('Configura el servidor primero');window.open(url,'_blank');}
function clearChat(){if(!confirm('¬øLimpiar mensajes?'))return;var panel=document.getElementById('chat-panel');panel.innerHTML='<div class="chat-spacer" id="chat-spacer"></div><div id="chat-placeholder">Los mensajes aparecer√°n aqu√≠<br><span style="font-size:11px;letter-spacing:3px;">‚Äî „Å≤„Å®„Å§„ÇÅÊßò ‚Äî</span></div>';messages=[];toast('Chat limpiado');}
function exportMessages(){var data=messages.map(function(m,i){return{id:i+1,name:m.data.chatname,message:m.data.chatmessage,platform:m.data.platform||m.data.type,timestamp:new Date().toISOString()};});var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='meeve_messages_'+Date.now()+'.json';a.click();URL.revokeObjectURL(url);toast('Exportado');}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function injectTestMessage(){appendMessage({type:'twitch',platform:'twitch',chatname:'TestViewer',chatmessage:'Hola! Kappa que tal PogChamp',nameColor:'#9146FF',chatemotes:[{text:'Kappa',url:'https://static-cdn.jtvnw.net/emoticons/v2/25/default/dark/1.0',start:7,end:11},{text:'PogChamp',url:'https://static-cdn.jtvnw.net/emoticons/v2/305954156/default/dark/1.0',start:18,end:25}],mid:'test-tw-'+Date.now()});setTimeout(function(){appendMessage({type:'kick',platform:'kick',chatname:'TestKick',chatmessage:'Hola [emote:1:GreenBalloon] como van',nameColor:'#3a9a2a',mid:'test-kick-'+Date.now()});},400);setTimeout(function(){appendMessage({type:'donation',platform:'twitch',donationType:'bits',chatname:'Donator',chatmessage:'Gran stream!',amount:500,nameColor:'#9146FF',mid:'test-bits-'+Date.now()});},800);toast('Mensajes de prueba listos');}
function toast(msg){var el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(function(){el.classList.remove('show');},2800);}
</script>
</body>
</html>
