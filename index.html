<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meeve Chat Overlay</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: transparent;
      min-height: 100vh;
      padding: 20px;
      font-family: 'Comic Sans MS', 'Segoe Print', 'Quicksand', cursive;
      overflow: hidden;
      position: relative;
    }

    .bg-particles {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none; z-index: 0; overflow: hidden;
    }

    .particle {
      position: absolute;
      width: 4px; height: 4px;
      background: #FF6B9D;
      border-radius: 50%; opacity: 0.6;
      animation: float 3s infinite ease-in-out;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) translateX(0); }
      50%       { transform: translateY(-20px) translateX(10px); }
    }

    .deco-line {
      position: fixed; height: 3px;
      background: linear-gradient(90deg, transparent, #FF6B9D, transparent);
      opacity: 0; z-index: 1; pointer-events: none;
    }

    #chat-container {
      position: absolute; bottom: 30px; left: 50%;
      transform: translateX(-50%);
      width: 100%; max-width: 650px;
      height: calc(100vh - 50px);
      overflow: hidden; padding: 0 20px; z-index: 10;
    }

    #spacer { width: 100%; height: 0px; background: transparent; }

    .message-bubble {
      position: relative; margin-bottom: 20px; opacity: 0;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }

    .message-bubble.visible { opacity: 1; }

    .bubble-left   { margin-left: 0; margin-right: auto; width: 80%; }
    .bubble-right  { margin-left: auto; margin-right: 0; width: 75%; }
    .bubble-center { margin-left: auto; margin-right: auto; width: 85%; }

    .bubble-container {
      position: relative;
      background: #FFFFFF;
      border: 4px solid #000000;
      border-radius: 30px;
      padding: 18px 22px;
      box-shadow: 8px 8px 0 rgba(0,0,0,0.9);
      overflow: visible;
    }

    .bubble-container::before {
      content: '';
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: url('https://media1.tenor.com/m/FlIAx4vYBJQAAAAC/as-you-like-it-eve.gif');
      background-size: cover; background-position: center;
      opacity: 0.25; z-index: 0; border-radius: inherit;
      pointer-events: none; mix-blend-mode: multiply;
    }

    .bubble-container::after {
      content: ''; position: absolute;
      top: -2px; left: -2px; right: -2px; bottom: -2px;
      background: inherit; border-radius: inherit;
      z-index: -1; opacity: 0; transition: opacity 0.3s;
    }

    .bubble-container.glitch::after {
      opacity: 0.5; animation: glitch 0.3s;
    }

    @keyframes glitch {
      0%   { transform: translate(0); }
      20%  { transform: translate(-2px, 2px);  filter: hue-rotate(90deg); }
      40%  { transform: translate(2px, -2px);  filter: hue-rotate(180deg); }
      60%  { transform: translate(-2px, -2px); filter: hue-rotate(270deg); }
      80%  { transform: translate(2px, 2px);   filter: hue-rotate(360deg); }
      100% { transform: translate(0); }
    }

    .bubble-container > * { position: relative; z-index: 1; }

    .pastel-yellow   { background: linear-gradient(135deg, #FFE66D 0%, #FFDB4D 50%, #FFC93D 100%); }
    .pastel-pink     { background: linear-gradient(135deg, #FF9ECD 0%, #FF6BB3 50%, #FF4D9E 100%); }
    .pastel-blue     { background: linear-gradient(135deg, #89D4FF 0%, #5EC5FF 50%, #3BB5FF 100%); }
    .pastel-lavender { background: linear-gradient(135deg, #D4BBFF 0%, #B794FF 50%, #A67CFF 100%); }
    .pastel-peach    { background: linear-gradient(135deg, #FFB088 0%, #FF9666 50%, #FF7F4D 100%); }
    .pastel-mint     { background: linear-gradient(135deg, #7FFFD4 0%, #5FFFB3 50%, #3FFF9E 100%); }

    .bubble-tail-left {
      position: absolute; bottom: 15px; left: -14px;
      width: 0; height: 0; border-style: solid;
      border-width: 0 18px 24px 0;
      border-color: transparent #000000 transparent transparent;
      filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3));
    }
    .bubble-tail-left::after {
      content: ''; position: absolute; top: 3px; left: 5px;
      width: 0; height: 0; border-style: solid;
      border-width: 0 14px 19px 0;
      border-color: transparent #FFFFFF transparent transparent;
    }

    .bubble-tail-right {
      position: absolute; bottom: 15px; right: -14px;
      width: 0; height: 0; border-style: solid;
      border-width: 0 0 24px 18px;
      border-color: transparent transparent transparent #000000;
      filter: drop-shadow(-2px 2px 0 rgba(0,0,0,0.3));
    }
    .bubble-tail-right::after {
      content: ''; position: absolute; top: 3px; right: 5px;
      width: 0; height: 0; border-style: solid;
      border-width: 0 0 19px 14px;
      border-color: transparent transparent transparent #FFFFFF;
    }

    .message-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }

    .avatar-box {
      width: 48px; height: 48px; border-radius: 50%;
      border: 4px solid #000000; overflow: hidden;
      background: #FFFFFF; flex-shrink: 0;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
      transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .avatar-box:hover { transform: scale(1.1) rotate(5deg); }
    .avatar { width: 100%; height: 100%; background-size: cover; background-position: center; }

    .username-box { flex: 1; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }

    .username {
      font-weight: 900; font-size: 21px; color: #000000;
      text-shadow: 3px 3px 0 rgba(255,255,255,0.7), -1px -1px 0 rgba(255,255,255,0.3);
      letter-spacing: 0.5px;
      animation: text-pop 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes text-pop {
      0%   { transform: scale(0.8); }
      100% { transform: scale(1); }
    }

    /* Badge de plataforma */
    .platform-badge {
      display: inline-flex; align-items: center; justify-content: center;
      width: 22px; height: 22px; border-radius: 50%;
      border: 3px solid #000000; font-size: 11px;
      box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
      flex-shrink: 0;
    }
    .platform-badge.twitch  { background: #9146FF; }
    .platform-badge.kick    { background: #53FC18; }
    .platform-badge.tiktok  { background: #FF0050; }
    .platform-badge.custom  { background: #FF6B9D; }

    .badge {
      display: inline-block; height: 22px; vertical-align: middle;
      filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3));
      animation: badge-spin 0.5s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes badge-spin {
      0%   { transform: rotate(-180deg) scale(0); }
      100% { transform: rotate(0) scale(1); }
    }

    .source-icon {
      width: 22px; height: 22px; border-radius: 50%;
      border: 3px solid #000000; background: #FFFFFF;
      padding: 2px; box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
    }

    .message-content {
      background: rgba(255,255,255,0.75);
      border: 3px solid #000000; border-radius: 18px;
      padding: 14px 18px; font-size: 23px;
      line-height: 1.5; color: #000000; font-weight: 700;
      word-wrap: break-word;
      box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);
      animation: content-appear 0.4s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes content-appear {
      0%   { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1);    opacity: 1; }
    }
    .message-content img { max-width: 80px; max-height: 28px; vertical-align: middle; }

    .donation-text {
      background: linear-gradient(135deg, #7FFF7F 0%, #5FFF5F 50%, #3FFF3F 100%);
      border: 4px solid #000000; border-radius: 18px;
      padding: 12px 16px; margin-top: 10px;
      font-size: 20px; font-weight: 900; color: #000000;
      text-align: center;
      box-shadow: 5px 5px 0 rgba(0,0,0,0.5);
      animation: donation-pulse 0.6s cubic-bezier(0.34,1.56,0.64,1);
      position: relative; overflow: hidden;
    }
    .donation-text::before {
      content: ''; position: absolute;
      top: -50%; left: -50%; width: 200%; height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.5), transparent);
      animation: shine 2s infinite;
    }
    @keyframes donation-pulse { 0% { transform: scale(0.8); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes shine { 0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); } 100% { transform: translateX(100%) translateY(100%) rotate(45deg); } }

    .membership-badge {
      background: linear-gradient(135deg, #FFD700, #FFB700);
      border: 3px solid #000000; border-radius: 14px;
      padding: 6px 14px; font-size: 17px; font-weight: 900;
      color: #000000; display: inline-block; margin-bottom: 8px;
      box-shadow: 3px 3px 0 rgba(0,0,0,0.5);
      animation: badge-wobble 0.5s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes badge-wobble {
      0% { transform: rotate(-5deg); } 25% { transform: rotate(5deg); }
      50% { transform: rotate(-3deg); } 75% { transform: rotate(3deg); }
      100% { transform: rotate(0); }
    }

    .content-image {
      max-width: 100%; max-height: 180px; margin-top: 10px;
      border-radius: 15px; border: 4px solid #000000;
      box-shadow: 5px 5px 0 rgba(0,0,0,0.5);
      animation: image-zoom 0.5s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes image-zoom { 0% { transform: scale(0.8) rotate(-5deg); } 100% { transform: scale(1) rotate(0); } }

    .deco-sparkle {
      position: absolute; width: 20px; height: 20px;
      top: -15px; right: 30px; z-index: 10;
    }
    .deco-sparkle::before, .deco-sparkle::after {
      content: '‚ú¶'; position: absolute;
      font-size: 22px; color: #FF6B9D;
      text-shadow: 2px 2px 0 #000000;
      animation: twinkle-enhanced 1.5s ease-in-out infinite;
    }
    .deco-sparkle::after { left: 18px; animation-delay: 0.75s; color: #FFD700; }
    @keyframes twinkle-enhanced {
      0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
      50%       { opacity: 0.3; transform: scale(0.6) rotate(180deg); }
    }

    .deco-heart {
      position: absolute; bottom: -15px; left: 30px;
      font-size: 24px; text-shadow: 2px 2px 0 #000000;
      animation: pulse-heart-enhanced 1.2s ease-in-out infinite; z-index: 10;
    }
    @keyframes pulse-heart-enhanced {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.15) rotate(-5deg); }
      75% { transform: scale(1.15) rotate(5deg); }
    }

    .spinning-gif {
      position: absolute; width: 60px; height: 60px;
      top: -30px; right: -30px; pointer-events: none; z-index: 10;
    }
    .spinning-gif img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(3px 3px 0 rgba(0,0,0,0.5)); }

    .confetti {
      position: absolute; width: 8px; height: 8px;
      background: #FF6B9D; top: 50%; left: 50%;
      opacity: 0; border-radius: 50%; z-index: 100;
    }
    @keyframes confetti-burst {
      0%   { opacity: 1; transform: translate(0,0) rotate(0deg); }
      100% { opacity: 0; transform: translate(var(--x), var(--y)) rotate(720deg); }
    }

    /* Indicador de conexi√≥n (esquina superior derecha) */
    #connection-dot {
      position: fixed; top: 10px; right: 10px;
      width: 10px; height: 10px; border-radius: 50%;
      background: #ef4444; z-index: 999;
      transition: background 0.3s;
      box-shadow: 0 0 6px currentColor;
    }
    #connection-dot.connected { background: #22c55e; }

    @media (max-width: 600px) {
      .bubble-container { padding: 14px 18px; }
      .username { font-size: 19px; }
      .message-content { font-size: 20px; }
      .message-bubble { width: 90% !important; }
      .spinning-gif { width: 50px; height: 50px; top: -25px; right: -25px; }
    }
  </style>
</head>
<body>
  <div class="bg-particles" id="particles"></div>
  <div id="connection-dot" title="Conexi√≥n al servidor"></div>
  <div id="chat-container">
    <div id="message-list-wrapper">
      <div id="spacer"></div>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ CONFIG (leer desde URL params) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const urlParams  = new URLSearchParams(window.location.search);
    // server=wss://TU-APP.onrender.com  (se pasa desde OBS URL)
    const SERVER_URL = urlParams.get('server') || 'wss://localhost:3000';
    const MAX_MESSAGES = urlParams.has('limit') ? parseInt(urlParams.get('limit')) : 50;
    const MAX_SPACER_HEIGHT_BEFORE_RESET = 5000;

    // ‚îÄ‚îÄ PART√çCULAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const particlesContainer = document.getElementById('particles');
    const pColors = ['#FF6B9D','#FFD700','#89D4FF','#D4BBFF','#7FFF7F'];
    for (let i = 0; i < 15; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.left = Math.random() * 100 + '%';
      p.style.top  = Math.random() * 100 + '%';
      p.style.background = pColors[Math.floor(Math.random() * pColors.length)];
      p.style.animationDelay    = Math.random() * 3 + 's';
      p.style.animationDuration = (Math.random() * 2 + 2) + 's';
      particlesContainer.appendChild(p);
    }

    // L√≠neas decorativas
    function createDecoLine() {
      const line = document.createElement('div');
      line.className = 'deco-line';
      line.style.width = Math.random() * 300 + 100 + 'px';
      line.style.top   = Math.random() * 100 + '%';
      line.style.left  = Math.random() * 100 + '%';
      document.body.appendChild(line);
      gsap.to(line, { opacity: 0.8, duration: 0.3, onComplete: () =>
        gsap.to(line, { opacity: 0, duration: 0.3, delay: 0.5, onComplete: () => line.remove() })
      });
    }
    setInterval(() => { if (Math.random() > 0.7) createDecoLine(); }, 2000);

    // ‚îÄ‚îÄ ESTADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const chatContainer      = document.getElementById('chat-container');
    const messageListWrapper = document.getElementById('message-list-wrapper');
    const topSpacer          = document.getElementById('spacer');
    const connectionDot      = document.getElementById('connection-dot');

    const pastelColors    = ['pastel-yellow','pastel-pink','pastel-blue','pastel-lavender','pastel-peach','pastel-mint'];
    const bubblePositions = ['bubble-left','bubble-right','bubble-center'];
    const decorations     = ['üí´','‚≠ê','‚ú®','üåü','üíñ','üíï','üå∏','üéÄ','üåà','‚ö°'];
    const platformIcons   = { twitch: 'üü£', kick: 'üü¢', tiktok: 'üéµ', custom: '‚≠ê' };

    let colorIndex = 0, positionIndex = 0;

    const getNextPastelColor = () => { const c = pastelColors[colorIndex]; colorIndex = (colorIndex+1) % pastelColors.length; return c; };
    const getNextPosition    = () => { const p = bubblePositions[positionIndex]; positionIndex = (positionIndex+1) % bubblePositions.length; return p; };
    const getRandomDeco      = () => decorations[Math.floor(Math.random() * decorations.length)];

    function createConfetti(element) {
      const cc = ['#FF6B9D','#FFD700','#89D4FF','#7FFF7F','#D4BBFF'];
      for (let i = 0; i < 15; i++) {
        const el = document.createElement('div');
        el.className = 'confetti';
        el.style.background = cc[Math.floor(Math.random() * cc.length)];
        const angle = (Math.PI * 2 * i) / 15;
        const dist  = 80 + Math.random() * 40;
        el.style.setProperty('--x', Math.cos(angle) * dist + 'px');
        el.style.setProperty('--y', Math.sin(angle) * dist + 'px');
        el.style.animation = `confetti-burst ${0.8 + Math.random() * 0.4}s ease-out forwards`;
        element.appendChild(el);
        setTimeout(() => el.remove(), 1200);
      }
    }

    function adjustScroll() {
      requestAnimationFrame(() => {
        const sh = messageListWrapper.scrollHeight;
        const ch = chatContainer.clientHeight;
        let ty = sh > ch ? -(sh - ch) : 0;
        ty = Math.min(0, ty);
        gsap.killTweensOf(messageListWrapper);
        gsap.to(messageListWrapper, { y: ty, duration: 0.5, ease: 'power2.out' });
      });
    }

    // ‚îÄ‚îÄ AGREGAR MENSAJE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function addMessage(data) {
      if (!data.chatname && !data.chatmessage && !data.hasDonation && !data.contentimg) return;

      const messageDiv = document.createElement('div');
      messageDiv.id    = data.mid || 'msg-' + Date.now();
      messageDiv.classList.add('message-bubble', getNextPosition());

      const pastelColor = getNextPastelColor();
      const tailClass   = messageDiv.classList.contains('bubble-right') ? 'bubble-tail-right' : 'bubble-tail-left';
      const platform    = data.platform || data.type || 'custom';
      const icon        = platformIcons[platform] || 'üí¨';

      const avatarHtml = data.chatimg
        ? `<div class="avatar-box"><div class="avatar" style="background-image:url('${data.chatimg}');"></div></div>` : '';

      const badgeHtml = `<span class="platform-badge ${platform}" title="${platform}">${icon}</span>`;

      const nameHtml = data.chatname
        ? `<span class="username" style="${data.nameColor ? `color:${data.nameColor};` : ''}">${data.chatname}</span>` : '';

      const membershipHtml = data.membership ? `<div class="membership-badge">${data.membership}</div>` : '';
      const msgHtml        = data.chatmessage ? `<div class="message-content">${data.chatmessage}</div>` : '';
      const donationHtml   = data.hasDonation ? `<div class="donation-text">${data.hasDonation}</div>` : '';
      const imgHtml        = data.contentimg  ? `<img src="${data.contentimg}" alt="" class="content-image" onerror="this.style.display='none'">` : '';

      messageDiv.innerHTML = `
        <div class="bubble-container ${pastelColor}">
          <div class="${tailClass}"></div>
          <div class="spinning-gif"><img src="https://media1.tenor.com/m/7exwykqMlE0AAAAC/kurukuru-eve-kurukuru.gif" alt="spinning"></div>
          <div class="deco-sparkle"></div>
          <div class="deco-heart">${getRandomDeco()}</div>
          <div class="message-header">
            ${avatarHtml}
            <div class="username-box">${badgeHtml}${nameHtml}</div>
          </div>
          ${membershipHtml}${msgHtml}${donationHtml}${imgHtml}
        </div>`;

      messageListWrapper.appendChild(messageDiv);

      gsap.set(messageDiv, { opacity: 0, y: 50, scale: 0.85, rotation: Math.random() > 0.5 ? -8 : 8 });
      gsap.to(messageDiv, {
        opacity: 1, y: 0, scale: 1, rotation: 0,
        duration: 0.6, ease: 'back.out(1.7)',
        onStart:    () => messageDiv.classList.add('visible'),
        onComplete: () => {
          const c = messageDiv.querySelector('.bubble-container');
          if (Math.random() > 0.7) { c.classList.add('glitch'); setTimeout(() => c.classList.remove('glitch'), 300); }
          if (data.hasDonation) createConfetti(messageDiv);
          if (Math.random() > 0.7) gsap.to(c, { x: [0,-2,2,-2,2,0], duration: 0.3, ease: 'power2.inOut' });
          const ab = messageDiv.querySelector('.avatar-box');
          if (ab && Math.random() > 0.8) gsap.to(ab, { scale: 1.15, duration: 0.2, ease: 'power2.out', yoyo: true, repeat: 1 });
        }
      });

      // Eliminar mensajes viejos
      const msgs = [...messageListWrapper.children].filter(c => c.id !== 'spacer' && c.classList.contains('message-bubble'));
      if (msgs.length > MAX_MESSAGES) {
        const old = msgs[0];
        const mStyle = getComputedStyle(old);
        const space  = old.offsetHeight + (parseFloat(mStyle.marginBottom) || 0);
        let newH = (parseFloat(topSpacer.style.height) || 0) + space;
        if (newH > MAX_SPACER_HEIGHT_BEFORE_RESET) newH = 0;
        topSpacer.style.height = newH + 'px';
        gsap.killTweensOf(old);
        gsap.to(old, { opacity: 0, scale: 0.8, duration: 0.3, onComplete: () => {
          messageListWrapper.removeChild(old);
          setTimeout(adjustScroll, 50);
        }});
      }

      setTimeout(adjustScroll, 100);
    }

    // ‚îÄ‚îÄ WEBSOCKET al servidor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let ws, retryDelay = 1000;

    function connect() {
      try { ws = new WebSocket(SERVER_URL); } catch(e) {
        connectionDot.classList.remove('connected');
        setTimeout(connect, retryDelay);
        return;
      }

      ws.onopen = () => {
        connectionDot.classList.add('connected');
        retryDelay = 1000;
        console.log('[Overlay] Conectado a', SERVER_URL);
      };

      ws.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          // Ignorar mensajes de estado (type: 'status')
          if (data.type === 'status') return;
          addMessage(data);
        } catch (err) {}
      };

      ws.onclose = () => {
        connectionDot.classList.remove('connected');
        retryDelay = Math.min(retryDelay * 2, 30000);
        console.log('[Overlay] Desconectado, reintentando en', retryDelay, 'ms');
        setTimeout(connect, retryDelay);
      };

      ws.onerror = () => { ws.close(); };
    }

    connect();
  </script>
</body>
</html>
